<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10b981"> <title>WAR SAKEEB Tracker</title>
  <link rel="manifest" href="manifest.json">
  <style>
    /* === GREEN PREMIUM BENTO GRID === */
    :root {
      --text-dark: #064e3b;
      --text-muted: #64748b;
      --active-bg: #ecfdf5; 
      --active-text: #059669; 
      --spring: cubic-bezier(0.175, 0.885, 0.32, 1.25);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }

    body {
      background: #f8fafc;
      color: var(--text-dark);
      min-height: 100vh;
      display: flex; justify-content: center; align-items: center;
      padding: 1rem;
    }

    .app-container {
      width: 100%; max-width: 400px;
      display: flex; flex-direction: column; gap: 1rem;
    }

    header { text-align: center; margin-bottom: 0.5rem; }
    h1 { font-size: 1.5rem; letter-spacing: 2px; color: #065f46; }
    #date-text { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }

    .dashboard-panel {
      background: #ffffff; border-radius: 30px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.05);
      padding: 2rem 1.5rem; position: relative;
    }

    #current-time { font-size: 3.2rem; font-weight: 800; text-align: center; margin-bottom: 1rem; color: #1e293b; }
    .ampm { font-size: 1rem; color: #94a3b8; }

    .countdown-pill {
      background: #f1f5f9; padding: 0.6rem 1rem; border-radius: 100px;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      font-size: 0.9rem; font-weight: 700; margin: 0 auto 2rem; width: fit-content;
    }
    .dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 1.5s infinite; }

    .prayer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
    .prayer-card {
      background: #f8fafc; padding: 1.2rem; border-radius: 20px;
      display: flex; flex-direction: column; gap: 4px; transition: 0.3s;
    }
    .prayer-card.active { background: var(--active-bg); border: 1px solid #10b981; }
    .p-name { font-size: 0.85rem; font-weight: 700; color: var(--text-muted); }
    .p-time { font-size: 1.1rem; font-weight: 800; }
    .prayer-card.active .p-name { color: var(--active-text); }

    .tahajjud-card { grid-column: span 2; flex-direction: row; justify-content: space-between; align-items: center; }

    .audio-btn {
      position: absolute; top: 1rem; right: 1rem;
      border: none; background: #f1f5f9; width: 40px; height: 40px;
      border-radius: 50%; cursor: pointer; font-size: 1.2rem;
    }
    .audio-btn.on { background: #d1fae5; color: #059669; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
  </style>
</head>
<body>

  <div class="app-container">
    <header>
      <h1 id="date-text">...</h1>
      <h1>WAR SAKEEB</h1>
    </header>
    
    <main class="dashboard-panel">
      <button id="audio-btn" class="audio-btn">ðŸ”‡</button>
      <div id="current-time">00:00 <span class="ampm">AM</span></div>
      
      <div class="countdown-pill">
        <div class="dot"></div>
        <span id="countdown">Calculating...</span>
      </div>

      <div class="prayer-grid" id="grid"></div>
    </main>
  </div>

  <script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    // === ADHAN.MP3 FIX ===
    const adhan = new Audio('Adhan.mp3'); 
    let audioOn = false;
    let lastPlayed = "";

    document.getElementById('audio-btn').onclick = (e) => {
      audioOn = !audioOn;
      e.target.innerHTML = audioOn ? "ðŸ”Š" : "ðŸ”‡";
      e.target.classList.toggle('on');
      if(audioOn) adhan.play().then(() => adhan.pause()); // Unlock audio
    };

    function update() {
      const now = new Date();
      document.getElementById('current-time').innerHTML = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}).replace(/ /g, ' <span class="ampm">') + '</span>';
      document.getElementById('date-text').innerText = now.toLocaleDateString('en-US', {weekday: 'long', month: 'short', day: 'numeric'});
      
      const timings = JSON.parse(localStorage.getItem('timings'));
      if (timings) {
        const pList = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];
        let next = null;

        pList.forEach(name => {
          const [h, m] = timings[name].split(':');
          const pDate = new Date(); pDate.setHours(h, m, 0);
          
          if (!next && pDate > now) {
            next = { name, time: pDate };
            // Auto Play Adhan
            if (audioOn && Math.abs(pDate - now) < 2000 && lastPlayed !== name && name !== "Sunrise") {
              adhan.currentTime = 0; adhan.play(); lastPlayed = name;
            }
          }
        });

        if (next) {
          const diff = next.time - now;
          const hh = Math.floor(diff / 3600000);
          const mm = Math.floor((diff % 3600000) / 60000);
          const ss = Math.floor((diff % 60000) / 1000);
          document.getElementById('countdown').innerHTML = `Next: ${next.name} in ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
        }
      }
      requestAnimationFrame(update);
    }

    async function getData() {
      navigator.geolocation.getCurrentPosition(async pos => {
        const res = await fetch(`https://api.aladhan.com/v1/timings/${Math.floor(Date.now()/1000)}?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&method=2`);
        const json = await res.json();
        localStorage.setItem('timings', JSON.stringify(json.data.timings));
        render(json.data.timings);
      });
    }

    function render(t) {
      const names = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];
      const grid = document.getElementById('grid');
      grid.innerHTML = names.map(n => `
        <div class="prayer-card">
          <span class="p-name">${n}</span>
          <span class="p-time">${t[n]}</span>
        </div>
      `).join('') + `
        <div class="prayer-card tahajjud-card">
          <span class="p-name">âœ¨ Tahajjud</span>
          <span class="p-time">02:30 AM</span>
        </div>
      `;
    }

    getData();
    update();
  </script>
</body>
</html>
